<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Test - Frame Per Layer Test</title>
    <link rel="icon" href="favicon.ico">
    <meta name="description" content="FPL is a device performance test that tests the load on a large number of objects.">
    <meta name="keywords" content="test, frames, per, schoolchildren, students, FPL, Sliz, layer">
    <meta name="author" content="Sliz®">
    <meta name="robots" content="index, follow">
    <link rel="icon" type="image/ico" href="https://fpl.pp.ua/favicon.ico">
    <link rel="apple-touch-icon" href="https://fpl.pp.ua/icon.png">
    <meta property="og:title" content="FPL Test - Frame Per Layer Test">
    <meta property="og:description" content="FPL is a device performance test that tests the load on a large number of objects.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://fpl.pp.ua/">
    <meta property="og:image" content="https://fpl.pp.ua/favicon.ico">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="FPL Test - Frame Per Layer Test">
    <meta name="twitter:description" content="FPL is a device performance test that tests the load on a large number of objects.">
    <meta name="twitter:image" content="https://fpl.pp.ua/icon.png">
    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "FPL",
  "url": "https://fpl.pp.ua/",
  "logo": "https://fpl.pp.ua/favicon.ico",
  "description": "FPL is a device performance test that tests the load on a large number of objects."
}
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
            user-select: none;
        }

        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .ui-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10;
            pointer-events: none;
        }

        .stats-panel {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            min-width: 250px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .fps-display {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
            color: #00ff88;
        }

        .fps-minmax {
            font-size: 14px;
            opacity: 0.7;
            margin: 5px 0;
        }

        .ball-count {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ball-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 16px;
        }

        .ball-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            animation: modalSlide 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-title {
            font-size: 32px;
            margin-bottom: 20px;
            color: #00ff88;
        }

        .modal-stats {
            margin: 20px auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .modal-stat {
            margin: 10px 0;
            font-size: 18px;
        }

        .device-info {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .device-info-title {
            font-size: 20px;
            color: #00d4ff;
            margin-bottom: 15px;
        }

        .device-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 16px;
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .leaderboard-item.highlighted {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 165, 0, 0.3));
            border: 2px solid gold;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .leaderboard-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .leaderboard-rank {
            font-size: 24px;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }

        .medal {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .medal.gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
        }

        .medal.silver {
            background: linear-gradient(135deg, #C0C0C0, #808080);
            color: #000;
        }

        .medal.bronze {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: #fff;
        }

        .leaderboard-name {
            font-size: 18px;
            font-weight: 500;
        }

        .leaderboard-balls {
            font-size: 16px;
            opacity: 0.8;
            white-space: nowrap;
        }

        .button-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 30px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .btn-repeat {
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            color: #000;
        }

        .btn-reset {
            background: linear-gradient(135deg, #ff006e, #ff6b35);
            color: white;
        }

        .btn-devices {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-back {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: #000;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .hint {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 107, 53, 0.9);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            animation: hintPulse 0.5s ease;
            z-index: 50;
            display: none;
        }

        .hint.active {
            display: block;
        }

        @keyframes hintPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        .stats-view {
            display: block;
        }

        .leaderboard-view {
            display: none;
        }

        .stats-view.hidden {
            display: none;
        }

        .leaderboard-view.active {
            display: block;
        }

        @media (max-width: 768px) {
            .stats-panel {
                min-width: 200px;
                padding: 15px;
            }

            .title {
                font-size: 22px;
            }

            .fps-display {
                font-size: 36px;
            }

            .modal-content {
                padding: 30px 20px;
            }

            button {
                padding: 12px 20px;
                font-size: 14px;
            }

            .leaderboard-item {
                padding: 10px;
            }

            .leaderboard-name {
                font-size: 16px;
            }

            .leaderboard-balls {
                font-size: 14px;
            }

            .medal {
                width: 30px;
                height: 30px;
                font-size: 16px;
            }
        }
.first-time-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.95);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 200;
}

.first-time-modal.active {
    display: flex;
}

.first-time-content {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(15px);
    padding: 40px 30px;
    border-radius: 20px;
    text-align: center;
    color: #00ff88;
    max-width: 500px;
    animation: slideIn 0.4s ease;
}

.first-time-content h2 {
    font-size: 32px;
    margin-bottom: 20px;
}

.first-time-content p {
    font-size: 18px;
    margin-bottom: 25px;
}

.first-time-content button {
    padding: 12px 25px;
    font-size: 16px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    background: linear-gradient(135deg, #00d4ff, #00ff88);
    color: #000;
    font-weight: bold;
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div class="ui-container">
        <div class="stats-panel">
            <div class="title">FPL Test</div>
            <div class="fps-display" id="fpsDisplay">-- FPS</div>
            <div class="fps-minmax">
                <div>Start: <span id="startFps">--</span> FPS</div>
                <div>↑ <span id="maxFps">--</span> FPS</div>
                <div>↓ <span id="minFps">--</span> FPS</div>
                <div>Created by: <strong>Sliz®</strong> | V48.4</div>
            </div>
            <div class="ball-count">
                <div class="ball-item">
                    <div class="ball-icon" style="background: white;"></div>
                    <span>White: <span id="ballCount">0</span></span>
                </div>
            </div>
        </div>
    </div>

    <div class="first-time-modal" id="firstTimeModal">
    <div class="first-time-content">
        <h2>Welcome!</h2>
        <p>To see the statistics, please <strong>hold your finger or LMB on the blue area</strong> until the results appear.</p>
        <p>Created by: <strong>Sliz®</strong> We are not responsible for your device. <strong>(But the test is safe.)</strong></p>
        <p>Latest version of the project: <strong>48.4</strong></p>
        <button id="fineButton">Fine</button>
    </div>
</div>

    <div class="hint" id="hint"></div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="stats-view" id="statsView">
                <div class="modal-title">Test Complete!</div>
                <div class="modal-stats">
                    <div class="modal-stat">Total Balls: <strong id="totalBalls">0</strong></div>
                    <div class="modal-stat">Start FPS: <strong id="modalStartFps">--</strong></div>
                    <div class="modal-stat">Max FPS: <strong id="modalMaxFps">--</strong></div>
                    <div class="modal-stat">Min FPS: <strong id="modalMinFps">--</strong></div>
                    <div class="modal-stat">Average FPS: <strong id="avgFps">--</strong></div>
                </div>
                <div class="device-info" id="deviceInfo">
                    <div class="device-info-title">Similar devices:</div>
                    <div id="deviceList">Analyzing...</div>
                </div>
                <div class="button-container">
                    <button class="btn-reset" onclick="resetAndRepeat()">Repeat Test</button>
                    <button class="btn-devices" onclick="showLeaderboard()">Devices</button>
                    <button class="btn-devices" onclick="addDevice()">Add my device</button>
                </div>
            </div>

            <div class="leaderboard-view" id="leaderboardView">
                <div class="modal-title">Top 10 Devices</div>
                <div id="leaderboardList"></div>
<div class="button-container">
    <button class="btn-back" onclick="hideLeaderboard()">Back to Stats</button>
    <button class="btn-devices" onclick="showAllDevices()">View all devices</button>
</div>
            </div>

            <div class="leaderboard-view" id="allDevicesView" style="display:none;">
    <div class="modal-title">All Devices</div>
    <div id="allDevicesList" style="
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 10px;
    "></div>
<div class="button-container">
    <button class="btn-back" onclick="hideLeaderboard()">Back to Stats</button>
    <button class="btn-devices" onclick="showAllSimilarDevices()">View all similar devices</button>
</div>
</div>

<div class="modal" id="similarDevicesModal" style="display:none;">
    <div class="modal-content">
        <div class="modal-title">Similar Devices</div>
        <div id="similarDevicesList" style="max-height:60vh; overflow-y:auto;"></div>
        <div class="button-container">
            <button class="btn-back" onclick="hideSimilarDevices()">Back</button>
        </div>
    </div>
</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const HOLD_INTERVAL = 500;
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let balls = [];
        let fps = 60;
        let startFps = null;
        let maxFps = 60;
        let minFps = 60;
        let lastTime = performance.now();
        let frameCount = 0;
        let fpsSum = 0;
        let isHolding = false;
        let holdTimer = null;
        let spawnRate = 200;
        let totalSpawned = 0;
        let clickCount = 0;
        let testEnded = false;
        let measurementStarted = false;
        let lastFpsUpdate = performance.now();
        let fpsBuffer = [];
        let lowFpsStartTime = null;
        let startFpsCaptured = false;
        let deviceDatabase = [];
        let userBallCount = 0;
        let isMouseDown = false;
        let lastSpawn = 0;
        let lastTrigger = 0;
        let currentX = 0;
        let currentY = 0;
        let previousScreen = null;

        console.log('%c[FPL] Attention! You are in the DevTools console; this is for developers only. If you are a beta tester or have found a bug, you can view the logs and request help on the official Github page.', 'color: darkgreen; font-weight: bold;');

(async function policeCheck() {
    console.group('%c[POLICE] Running system checks...', 'color: darkblue; font-weight: bold;');

    if (location.protocol !== 'https:') {
        console.error('%c[ERROR] Connection is HTTP', 'color: red; font-weight: bold;');
        return;
    } 
    console.log('%c[OK] HTTPS verified', 'color: green; font-weight: bold;');

    try {
        document.cookie = "testCookie=1; max-age=10";
        const cookieValue = document.cookie.split('; ').find(row => row.startsWith('testCookie='));
        if (!cookieValue) throw new Error('Cookie blocked or not set');
        console.log('%c[OK] Cookie read/write works', 'color: green; font-weight: bold;');
        document.cookie = "testCookie=; max-age=0";
    } catch (err) {
        console.error('%c[ERROR] Cookie test failed:', 'color: red; font-weight: bold;', err);
        return;
    }

    try {
        localStorage.setItem('testLocal', '1');
        if (localStorage.getItem('testLocal') !== '1') throw new Error('localStorage not working');
        console.log('%c[OK] localStorage read/write works', 'color: green; font-weight: bold;');
        localStorage.removeItem('testLocal');
    } catch (err) {
        console.error('%c[ERROR] localStorage test failed:', 'color: red; font-weight: bold;', err);
        return;
    }

    console.log('%c[POLICE] All checks passed, main script can start.', 'color: darkblue; font-weight: bold;');
    console.log('%c---', 'color: darkgreen; font-weight: bold;');
    console.log('%c[POLICE] Version of code: 48.4', 'color: darkblue; font-weight: bold;');
    console.groupEnd();
})();

async function loadDeviceDatabase() {
    try {
        console.log('%c[FPL] Connecting to server...', 'color: darkblue; font-weight: bold;');
        const response = await fetch('https://device-db.markd-voznyuk.workers.dev/devices', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            cache: 'no-store'
        });

        if (!response.ok) throw new Error(`%c[FPL] HTTP error! status: ${response.status}`, 'color: brown; font-weight: bold;');

        deviceDatabase = await response.json();
    console.log(
    '%c[WORKER] Connection with %cfpl.pp.ua%c successful.',
    'color: #50c878; font-weight: bold;',
    'color: #00c8ff; font-weight: bold;',
    'color: #50c878; font-weight: bold;'
);

        updateDeviceList();

    } catch (error) {
        console.error('%c[HTTP] Failed to load device database:', 'color: brown; font-weight: bold;', error);
        deviceDatabase = [];
        updateDeviceList();
    }
}

function updateDeviceList() {
    const similarDevices = findSimilarDevices(userBallCount);
    const deviceListHtml = similarDevices.map(device => 
        `<div class="device-item">${device}</div>`
    ).join('');
    document.getElementById('deviceList').innerHTML = deviceListHtml;
}

loadDeviceDatabase();

setInterval(() => {
    loadDeviceDatabase();
}, 5000);

        setTimeout(() => {
            measurementStarted = true;
        }, 2000);

        setTimeout(() => {
            if (!startFpsCaptured && balls.length === 0) {
                startFps = fps;
                startFpsCaptured = true;
                document.getElementById('startFps').textContent = startFps;
            }
        }, 3000);

        class Ball {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 8;
                this.vy = (Math.random() - 0.5) * 8;
                this.radius = 5 + Math.random() * 5;
                this.alpha = 1;
                this.trail = [];
            }

            update() {
                this.trail.push({x: this.x, y: this.y, alpha: this.alpha});
                if (this.trail.length > 10) this.trail.shift();

                this.x += this.vx;
                this.y += this.vy;

                if (this.x - this.radius < 0 || this.x + this.radius > canvas.width) {
                    this.vx *= -0.95;
                    this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
                }
                if (this.y - this.radius < 0 || this.y + this.radius > canvas.height) {
                    this.vy *= -0.95;
                    this.y = Math.max(this.radius, Math.min(canvas.height - this.radius, this.y));
                }

                this.vx *= 0.99;
                this.vy *= 0.99;
            }

            draw() {
                for (let i = 0; i < this.trail.length; i++) {
                    const t = this.trail[i];
                    const trailAlpha = (i / this.trail.length) * 0.3;
                    ctx.beginPath();
                    ctx.arc(t.x, t.y, this.radius * 0.7, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${trailAlpha})`;
                    ctx.fill();
                }

                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.shadowBlur = 15;
                ctx.shadowColor = 'rgba(255, 255, 255, 0.8)';
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        function spawnBalls(count, x, y) {
            for (let i = 0; i < count; i++) {
                balls.push(new Ball(x, y));
            }
            totalSpawned += count;
            updateBallCount();

            if (!startFpsCaptured && balls.length > 0) {
                startFps = fps;
                startFpsCaptured = true;
                document.getElementById('startFps').textContent = startFps;
            }
        }

function startHolding(isMouse = false) {
    if (testEnded) return;

    const now = performance.now();
    if (now - lastTrigger < 80) return;
    lastTrigger = now;

    if (isHolding) return;
    isHolding = true;

    holdTimer = setInterval(() => {
        if (!isHolding) {
            clearInterval(holdTimer);
            holdTimer = null;
            return;
        }

        const currentRate = spawnRate + Math.floor(totalSpawned / 1000) * 100;
        const batchSize = Math.floor(currentRate / 2);

        const spawnX = isMouse ? currentX : lastSpawnX;
        const spawnY = isMouse ? currentY : lastSpawnY;

        spawnBalls(batchSize, spawnX, spawnY);

    }, HOLD_INTERVAL);
}

canvas.addEventListener("mousedown", (e) => {
    if (e.button !== 0) return;
    if (isMouseDown) return;
    isMouseDown = true;
    startHolding(true);
});

canvas.addEventListener("mouseup", () => {
    isMouseDown = false;
    stopHolding();
});

canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    if (e.touches.length !== 1) return;
    const touch = e.touches[0];
    lastSpawnX = touch.clientX;
    lastSpawnY = touch.clientY;
    startHolding(false);
});

canvas.addEventListener('touchend', stopHolding);
canvas.addEventListener('touchcancel', stopHolding);

canvas.addEventListener('mousemove', (e) => {
    currentX = e.clientX;
    currentY = e.clientY;
});

function stopHolding() {
    isHolding = false;
    if (holdTimer) {
        clearInterval(holdTimer);
        holdTimer = null;
    }
}

        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });

        canvas.addEventListener('click', () => {
            if (testEnded) return;
            clickCount++;
            if (clickCount >= 3) {
                showHint();
                clickCount = 0;
            }
        });

window.addEventListener('load', () => {
    const firstTimeModal = document.getElementById('firstTimeModal');
    const fineButton = document.getElementById('fineButton');
    if (!localStorage.getItem('firstTimeShown')) {
        firstTimeModal.classList.add('active');
    }

    fineButton.addEventListener('click', () => {
        firstTimeModal.classList.remove('active');
        localStorage.setItem('firstTimeShown', 'true');
    });
});

        function showHint() {
            const hint = document.getElementById('hint');
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            hint.textContent = isMobile ? 'Hold down on the free area' : 'Hold down LMB (Left Mouse Button)';
            hint.classList.add('active');
            setTimeout(() => {
                hint.classList.remove('active');
            }, 3000);
        }

        function updateBallCount() {
            document.getElementById('ballCount').textContent = balls.length;
        }

        function findSimilarDevices(ballCount) {
            if (deviceDatabase.length === 0) {
                return ['Device database not loaded'];
            }

            const tolerance = ballCount * 0.1;
            const matches = deviceDatabase.filter(device => {
                return Math.abs(device.balls - ballCount) <= tolerance;
            });

            matches.sort((a, b) => {
                return Math.abs(a.balls - ballCount) - Math.abs(b.balls - ballCount);
            });

            if (matches.length === 0) {
                return ['No similar devices found in database, save your device'];
            }

            return matches.slice(0, 2).map(device => device.name);
        }

        function showLeaderboard() {
            document.getElementById('statsView').classList.add('hidden');
            document.getElementById('leaderboardView').classList.add('active');

            previousScreen = 'leaderboard';

            const sortedDevices = [...deviceDatabase].sort((a, b) => b.balls - a.balls);
            const top10 = sortedDevices.slice(0, 10);

            const tolerance = userBallCount * 0.1;
            let leaderboardHtml = '';

            top10.forEach((device, index) => {
                const rank = index + 1;
                const isHighlighted = Math.abs(device.balls - userBallCount) <= tolerance;
                
                let rankDisplay = '';
                if (rank === 1) {
                    rankDisplay = '<div class="medal gold">1</div>';
                } else if (rank === 2) {
                    rankDisplay = '<div class="medal silver">2</div>';
                } else if (rank === 3) {
                    rankDisplay = '<div class="medal bronze">3</div>';
                } else {
                    rankDisplay = `<div class="leaderboard-rank">${rank}</div>`;
                }

                leaderboardHtml += `
                    <div class="leaderboard-item ${isHighlighted ? 'highlighted' : ''}">
                        <div class="leaderboard-left">
                            ${rankDisplay}
                            <div class="leaderboard-name">${device.name}</div>
                        </div>
                        <div class="leaderboard-balls">${device.balls} objects</div>
                    </div>
                `;
            });

            document.getElementById('leaderboardList').innerHTML = leaderboardHtml;
        }

function hideLeaderboard() {
    document.getElementById('statsView').classList.remove('hidden');
    document.getElementById('leaderboardView').classList.remove('active');
    document.getElementById('allDevicesView').style.display = 'none';
}

        function showAllDevices() {
    previousScreen = 'leaderboard';
    document.getElementById('leaderboardView').classList.remove('active');
    document.getElementById('allDevicesView').style.display = 'block';

    const sortedDevices = [...deviceDatabase].sort((a, b) => b.balls - a.balls);

    let html = '';
    sortedDevices.forEach((device, index) => {
        html += `
            <div class="leaderboard-item">
                <div class="leaderboard-left">
                    <div class="leaderboard-rank">${index + 1}</div>
                    <div class="leaderboard-name">${device.name}</div>
                </div>
                <div class="leaderboard-balls">${device.balls} objects</div>
            </div>
        `;
    });

    document.getElementById('allDevicesList').innerHTML = html;
}

function hideAllDevices() {
    document.getElementById('allDevicesView').style.display = 'none';
    document.getElementById('leaderboardView').classList.add('active');
}

function showAllSimilarDevices() {
    if (!userBallCount || deviceDatabase.length === 0) return;

    previousScreen = 'allDevices';

    const tolerance = userBallCount * 0.1;
    const similarDevices = deviceDatabase
        .filter(d => Math.abs(d.balls - userBallCount) <= tolerance)
        .sort((a,b)=>Math.abs(a.balls - userBallCount) - Math.abs(b.balls - userBallCount));

    let html = '';
    similarDevices.forEach((device, index)=>{
        let rankDisplay = '';
        if(index===0) rankDisplay = '<div class="medal gold">1</div>';
        else if(index===1) rankDisplay = '<div class="medal silver">2</div>';
        else if(index===2) rankDisplay = '<div class="medal bronze">3</div>';
        else rankDisplay = `<div class="leaderboard-rank">${index+1}</div>`;

        html += `
            <div class="leaderboard-item">
                <div class="leaderboard-left">
                    ${rankDisplay}
                    <div class="leaderboard-name">${device.name}</div>
                </div>
                <div class="leaderboard-balls">${device.balls} objects</div>
            </div>
        `;
    });

    document.getElementById('similarDevicesList').innerHTML = html;
    document.getElementById('similarDevicesModal').style.display = 'flex';
}

function hideSimilarDevices() {
    document.getElementById('similarDevicesModal').style.display = 'none';

    if (previousScreen === 'allDevices') {
        document.getElementById('allDevicesView').style.display = 'block';
        return;
    }

    if (previousScreen === 'leaderboard') {
        document.getElementById('leaderboardView').classList.add('active');
        return;
    }

    document.getElementById('statsView').classList.remove('hidden');
}

        function animate() {
            if (testEnded) return;

            const currentTime = performance.now();
            const delta = currentTime - lastTime;
            const currentFps = Math.round(1000 / delta);
            lastTime = currentTime;

            fpsBuffer.push(currentFps);

            if (currentTime - lastFpsUpdate >= 500) {
                const avgCurrentFps = Math.round(fpsBuffer.reduce((a, b) => a + b, 0) / fpsBuffer.length);
                fps = avgCurrentFps;
                fpsBuffer = [];
                lastFpsUpdate = currentTime;

                if (measurementStarted) {
                    if (fps < minFps) minFps = fps;
                    if (fps > maxFps) maxFps = fps;
                    
                    frameCount++;
                    fpsSum += fps;

                    document.getElementById('fpsDisplay').textContent = fps + ' FPS';
                    document.getElementById('maxFps').textContent = maxFps;
                    document.getElementById('minFps').textContent = minFps;

                    if (fps <= 1) {
                        if (lowFpsStartTime === null) {
                            lowFpsStartTime = currentTime;
                        } else if (currentTime - lowFpsStartTime >= 5000) {
                            endTest();
                            return;
                        }
                    } else {
                        lowFpsStartTime = null;
                    }
                }
            }

            ctx.fillStyle = 'rgba(102, 126, 234, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            balls.forEach(ball => {
                ball.update();
                ball.draw();
            });

            setTimeout(animate, 0);
        }

        function endTest() {
            testEnded = true;
            stopHolding();
            const avgFps = Math.round(fpsSum / frameCount);
            userBallCount = balls.length;
            
            document.getElementById('totalBalls').textContent = userBallCount;
            document.getElementById('modalStartFps').textContent = startFps || '--';
            document.getElementById('modalMaxFps').textContent = maxFps;
            document.getElementById('modalMinFps').textContent = minFps;
            document.getElementById('avgFps').textContent = avgFps;

            updateDeviceList();

            const similarDevices = findSimilarDevices(userBallCount);
            const deviceListHtml = similarDevices.map(device => 
                `<div class="device-item">${device}</div>`
            ).join('');
            document.getElementById('deviceList').innerHTML = deviceListHtml;
            
            document.getElementById('modal').classList.add('active');
        }

        function resetAndRepeat() {
            location.reload();
        }

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        animate();

async function addDevice() {
    const name = prompt("Enter device name (English letters only):");
    if (!name) return;

    if (!/^[A-Za-z0-9 _-]+$/.test(name)) {
        alert("Only English letters, numbers, spaces, _ and - allowed!");
        return;
    }

    const exists = deviceDatabase.some(device => device.name.toLowerCase() === name.toLowerCase());
    if (exists) {
        alert("This device name already exists in the database!");
        return;
    }

    const data = {
        name: name,
        balls: userBallCount
    };

    try {
        const response = await fetch("https://device-db.markd-voznyuk.workers.dev/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            alert("Error: " + await response.text());
            return;
        }

        alert("Device added successfully!");
        await loadDeviceDatabase();
        updateDeviceList();
        showLeaderboard();
    } catch (e) {
        alert("Failed to send data: " + e.message);
        console.error('%c[HTTP] Failed to send data: ' + e.message, 'color: brown; font-weight: bold;');
    }
}
    </script>
</body>
</html>
