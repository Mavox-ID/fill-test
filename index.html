<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #1a1a2e;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #container {
            position: relative;
            width: 100%;
            max-width: 1000px;
            height: 100%;
        }

        #canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #info-box {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            z-index: 10;
            border-left: 5px solid #00bcd4;
        }

        #fps-chart {
            width: 200px;
            height: 50px;
            border: 1px solid #00bcd4;
            margin-bottom: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        #fps-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #00bcd4;
            transition: height 0.1s;
        }

        .fps-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #ffeb3b;
            margin: 0;
            line-height: 1;
        }

        .fps-min-max {
            font-size: 0.8em;
            margin-top: 5px;
            color: #aaa;
        }

        .ball-count {
            margin-top: 15px;
            font-size: 1.1em;
            color: #f5f5f5;
        }
        
        #stats-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 20;
            padding: 20px;
        }

        #stats-content {
            background-color: #2e2a40;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0, 188, 212, 0.5);
            max-width: 400px;
            width: 90%;
        }

        #stats-content h2 {
            color: #00bcd4;
            margin-top: 0;
        }

        #stats-content p {
            font-size: 1.1em;
            line-height: 1.6;
        }

        .button-group {
            margin-top: 25px;
        }

        .test-button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        #repeat-button {
            background-color: #4caf50;
            color: white;
        }

        #repeat-button:hover {
            background-color: #66bb6a;
        }

        #reset-repeat-button {
            background-color: #f44336;
            color: white;
        }

        #reset-repeat-button:hover {
            background-color: #ef5350;
        }

        #start-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            z-index: 5;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="fpl-canvas"></canvas> 
        
        <div id="canvas-overlay">
            <div id="info-box">
                <h3>FPL Test</h3> 
                
                <div id="fps-chart">
                    <div id="fps-bar"></div>
                </div>

                <p class="fps-display" id="current-fps">0</p>
                
                <div class="fps-min-max">
                    <span id="max-fps">↑ 0 FPS</span>
                    <span id="min-fps">↓ 0 FPS</span>
                </div>
                
                <hr style="border-color: #333; margin: 10px 0;">

                <p class="ball-count">White Balls: <span id="ball-count-white">0</span></p>
                <p class="ball-count">Rate: <span id="spawn-rate">0/0.5s</span></p>
            </div>

            <div id="start-message">
                Click and hold anywhere outside the top-left box to start and add balls.
            </div>
            
            <div id="stats-overlay">
                <div id="stats-content">
                    <h2>Test Results</h2>
                    <p id="stat-total-balls">Total Balls: 0</p>
                    <p id="stat-min-fps">Minimum FPS Reached: 0</p>
                    <p id="stat-duration">Duration: 0s</p>
                    <p id="stat-max-rate">Max Spawn Rate: 0</p>
                    <div class="button-group">
                        <button class="test-button" id="repeat-button">Repeat Test</button>
                        <button class="test-button" id="reset-repeat-button">Reset and Repeat</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('fpl-canvas');
        const ctx = canvas.getContext('2d');
        const infoBox = document.getElementById('info-box');
        const startMessage = document.getElementById('start-message');
        const statsOverlay = document.getElementById('stats-overlay');
        const fpsDisplay = document.getElementById('current-fps');
        const maxFpsDisplay = document.getElementById('max-fps');
        const minFpsDisplay = document.getElementById('min-fps');
        const ballCountDisplay = document.getElementById('ball-count-white');
        const rateDisplay = document.getElementById('spawn-rate');
        const fpsBar = document.getElementById('fps-bar');

        let particles = [];
        let isTestRunning = false;
        let isMouseDown = false;
        let lastFrameTime = performance.now();
        let fps = 0;
        let maxFPS = 0;
        let minFPS = Infinity;
        let frameCount = 0;
        let lastFPSUpdateTime = performance.now();
        let testStartTime = 0;

        let spawnIntervalId = null;
        let currentSpawnRate = 100; // 100 particles per 0.5s
        let lastSpawnX = 0;
        let lastSpawnY = 0;

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 5; 
                this.vy = (Math.random() - 0.5) * 5;
                this.radius = 5;
                this.color = color;
            }

            draw() {
                ctx.shadowBlur = 10;
                ctx.shadowColor = this.color;
                
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                
                ctx.shadowBlur = 0; 
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vx *= 0.99; 
                this.vy *= 0.99; 
            }
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function checkClickOutsideInfo(clientX, clientY) {
            const rect = infoBox.getBoundingClientRect();
            return !(clientX >= rect.left && clientX <= rect.right && clientY >= rect.top && clientY <= rect.bottom);
        }

        function startSpawning(clientX, clientY) {
            if (!checkClickOutsideInfo(clientX, clientY)) return;

            isMouseDown = true;
            lastSpawnX = clientX;
            lastSpawnY = clientY;

            if (!isTestRunning) {
                isTestRunning = true;
                startMessage.style.display = 'none';
                testStartTime = performance.now();
            }

            const spawnFunction = () => {
                // Update spawn rate based on ball count
                const bonusRate = Math.floor(particles.length / 1000) * 100;
                currentSpawnRate = 100 + bonusRate;
                rateDisplay.textContent = `${currentSpawnRate}/0.5s`;

                for (let i = 0; i < currentSpawnRate; i++) {
                    particles.push(new Particle(lastSpawnX, lastSpawnY, 'white'));
                }
            };
            
            // Clear any existing interval to prevent duplicates
            if (spawnIntervalId) clearInterval(spawnIntervalId);
            
            spawnFunction(); // Spawn immediately
            spawnIntervalId = setInterval(spawnFunction, 500); // Repeat every 500ms (0.5s)
        }

        function stopSpawning() {
            isMouseDown = false;
            if (spawnIntervalId) {
                clearInterval(spawnIntervalId);
                spawnIntervalId = null;
            }
        }

        function handleMove(clientX, clientY) {
            if (isMouseDown) {
                lastSpawnX = clientX;
                lastSpawnY = clientY;
            }
        }
        
        canvas.addEventListener('mousedown', (e) => {
            if (e.button === 0 || e.button === 2) { 
                startSpawning(e.clientX, e.clientY);
            }
        });
        canvas.addEventListener('mouseup', stopSpawning);
        canvas.addEventListener('mouseout', stopSpawning);
        canvas.addEventListener('mousemove', (e) => handleMove(e.clientX, e.clientY));
        canvas.addEventListener('contextmenu', (e) => e.preventDefault());

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            const touch = e.touches[0];
            startSpawning(touch.clientX, touch.clientY);
        });
        canvas.addEventListener('touchend', stopSpawning);
        canvas.addEventListener('touchcancel', stopSpawning);
        canvas.addEventListener('touchmove', (e) => {
             if (e.touches.length > 0) {
                handleMove(e.touches[0].clientX, e.touches[0].clientY);
             }
        });

        function animate() {
            const now = performance.now();
            const deltaTime = now - lastFrameTime;

            if (isTestRunning) {
                frameCount++;
                if (now > lastFPSUpdateTime + 1000) {
                    fps = frameCount * 1000 / (now - lastFPSUpdateTime);
                    
                    const currentFPS = Math.round(fps);
                    
                    fpsDisplay.textContent = currentFPS;
                    
                    maxFPS = Math.max(maxFPS, currentFPS);
                    if (currentFPS > 0) { 
                        minFPS = Math.min(minFPS, currentFPS);
                    } else if (particles.length > 100) {
                        minFPS = 0;
                    }

                    maxFpsDisplay.textContent = `↑ ${maxFPS} FPS`;
                    minFpsDisplay.textContent = `↓ ${minFPS === Infinity ? 0 : minFPS} FPS`;

                    fpsBar.style.height = `${Math.min(100, (currentFPS / 60) * 100)}%`;
                    
                    frameCount = 0;
                    lastFPSUpdateTime = now;

                    if (currentFPS <= 0 && particles.length > 100) { 
                        stopTest();
                        return;
                    }
                }
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            particles.forEach(p => {
                p.update();
                p.draw();
            });

            ballCountDisplay.textContent = particles.length;

            lastFrameTime = now;
            requestAnimationFrame(animate);
        }

        function stopTest() {
            isTestRunning = false;
            stopSpawning();
            const durationSeconds = ((performance.now() - testStartTime) / 1000).toFixed(2);
            
            document.getElementById('stat-total-balls').textContent = `Total Balls: ${particles.length}`;
            document.getElementById('stat-min-fps').textContent = `Minimum FPS Reached: ${minFPS === Infinity ? 0 : minFPS} FPS`;
            document.getElementById('stat-duration').textContent = `Duration: ${durationSeconds}s`;
            document.getElementById('stat-max-rate').textContent = `Max Spawn Rate: ${currentSpawnRate}/0.5s`;
            
            statsOverlay.style.display = 'flex';
        }

        function resetStats() {
            particles = [];
            isTestRunning = false;
            isMouseDown = false;
            stopSpawning();
            fps = 0;
            maxFPS = 0;
            minFPS = Infinity;
            frameCount = 0;
            lastFrameTime = performance.now();
            lastFPSUpdateTime = performance.now();
            testStartTime = 0;
            currentSpawnRate = 100;

            fpsDisplay.textContent = 0;
            maxFpsDisplay.textContent = '↑ 0 FPS';
            minFpsDisplay.textContent = '↓ 0 FPS';
            ballCountDisplay.textContent = 0;
            rateDisplay.textContent = `0/0.5s`;
            fpsBar.style.height = '0%';
        }

        function repeatTest() {
            statsOverlay.style.display = 'none';
            particles = [];
            isTestRunning = false; // Reset to allow first click to start a new test
            testStartTime = 0;
            currentSpawnRate = 100;
            rateDisplay.textContent = `100/0.5s`;
            startMessage.style.display = 'block'; 
            animate();
        }

        function resetAndRepeatTest() {
            window.location.reload(); 
        }

        document.getElementById('repeat-button').addEventListener('click', repeatTest);
        document.getElementById('reset-repeat-button').addEventListener('click', resetAndRepeatTest);

        resetStats();
        animate();
    </script>
</body>
</html>
