<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Test - Frame Per Layer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
            user-select: none;
        }

        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .ui-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10;
            pointer-events: none;
        }

        .stats-panel {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            min-width: 250px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .fps-display {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
            color: #00ff88;
        }

        .fps-minmax {
            font-size: 14px;
            opacity: 0.7;
            margin: 5px 0;
        }

        .ball-count {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ball-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 16px;
        }

        .ball-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: modalSlide 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-title {
            font-size: 32px;
            margin-bottom: 20px;
            color: #00ff88;
        }

        .modal-stats {
            margin: 20px 0;
            text-align: left;
        }

        .modal-stat {
            margin: 10px 0;
            font-size: 18px;
        }

        .device-info {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .device-info-title {
            font-size: 20px;
            color: #00d4ff;
            margin-bottom: 15px;
        }

        .device-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 16px;
        }

        .button-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 30px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .btn-repeat {
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            color: #000;
        }

        .btn-reset {
            background: linear-gradient(135deg, #ff006e, #ff6b35);
            color: white;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .hint {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 107, 53, 0.9);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            animation: hintPulse 0.5s ease;
            z-index: 50;
            display: none;
        }

        .hint.active {
            display: block;
        }

        @keyframes hintPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        @media (max-width: 768px) {
            .stats-panel {
                min-width: 200px;
                padding: 15px;
            }

            .title {
                font-size: 22px;
            }

            .fps-display {
                font-size: 36px;
            }

            .modal-content {
                padding: 30px 20px;
            }

            button {
                padding: 12px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div class="ui-container">
        <div class="stats-panel">
            <div class="title">FPL Test</div>
            <div class="fps-display" id="fpsDisplay">60 FPS</div>
            <div class="fps-minmax">
                <div>Start: <span id="startFps">--</span> FPS</div>
                <div>↑ <span id="maxFps">60</span> FPS</div>
                <div>↓ <span id="minFps">60</span> FPS</div>
            </div>
            <div class="ball-count">
                <div class="ball-item">
                    <div class="ball-icon" style="background: white;"></div>
                    <span>White: <span id="ballCount">0</span></span>
                </div>
            </div>
        </div>
    </div>

    <div class="hint" id="hint"></div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-title">Test Complete!</div>
            <div class="modal-stats">
                <div class="modal-stat">Total Balls: <strong id="totalBalls">0</strong></div>
                <div class="modal-stat">Start FPS: <strong id="modalStartFps">60</strong></div>
                <div class="modal-stat">Max FPS: <strong id="modalMaxFps">60</strong></div>
                <div class="modal-stat">Min FPS: <strong id="modalMinFps">60</strong></div>
                <div class="modal-stat">Average FPS: <strong id="avgFps">60</strong></div>
            </div>
            <div class="device-info" id="deviceInfo">
                <div class="device-info-title">Info:</div>
                <div id="deviceList">Analyzing...</div>
            </div>
            <div class="button-container">
                <button class="btn-repeat" onclick="repeatTest()">Repeat Test</button>
                <button class="btn-reset" onclick="resetAndRepeat()">Reset and Repeat</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let balls = [];
        let fps = 60;
        let startFps = null;
        let maxFps = 60;
        let minFps = 60;
        let lastTime = performance.now();
        let frameCount = 0;
        let fpsSum = 0;
        let isHolding = false;
        let holdTimer = null;
        let spawnRate = 200;
        let totalSpawned = 0;
        let clickCount = 0;
        let testEnded = false;
        let measurementStarted = false;
        let lastFpsUpdate = performance.now();
        let fpsBuffer = [];
        let lowFpsStartTime = null;
        let startFpsCaptured = false;
        let deviceDatabase = [];

        async function loadDeviceDatabase() {
            try {
                const response = await fetch('https://mavox-id.github.io/FPL/device.json');
                deviceDatabase = await response.json();
            } catch (error) {
                console.error('Failed to load device database:', error);
                deviceDatabase = [];
            }
        }

        loadDeviceDatabase();

        setTimeout(() => {
            measurementStarted = true;
        }, 2000);

        setTimeout(() => {
            if (!startFpsCaptured && balls.length === 0) {
                startFps = fps;
                startFpsCaptured = true;
                document.getElementById('startFps').textContent = startFps;
            }
        }, 3000);

        class Ball {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 8;
                this.vy = (Math.random() - 0.5) * 8;
                this.radius = 5 + Math.random() * 5;
                this.alpha = 1;
                this.trail = [];
            }

            update() {
                this.trail.push({x: this.x, y: this.y, alpha: this.alpha});
                if (this.trail.length > 10) this.trail.shift();

                this.x += this.vx;
                this.y += this.vy;

                if (this.x - this.radius < 0 || this.x + this.radius > canvas.width) {
                    this.vx *= -0.95;
                    this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
                }
                if (this.y - this.radius < 0 || this.y + this.radius > canvas.height) {
                    this.vy *= -0.95;
                    this.y = Math.max(this.radius, Math.min(canvas.height - this.radius, this.y));
                }

                this.vx *= 0.99;
                this.vy *= 0.99;
            }

            draw() {
                for (let i = 0; i < this.trail.length; i++) {
                    const t = this.trail[i];
                    const trailAlpha = (i / this.trail.length) * 0.3;
                    ctx.beginPath();
                    ctx.arc(t.x, t.y, this.radius * 0.7, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${trailAlpha})`;
                    ctx.fill();
                }

                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.shadowBlur = 15;
                ctx.shadowColor = 'rgba(255, 255, 255, 0.8)';
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        function spawnBalls(count, x, y) {
            for (let i = 0; i < count; i++) {
                balls.push(new Ball(x, y));
            }
            totalSpawned += count;
            updateBallCount();

            if (!startFpsCaptured && balls.length > 0) {
                startFps = fps;
                startFpsCaptured = true;
                document.getElementById('startFps').textContent = startFps;
            }
        }

        function startHolding(x, y) {
            if (testEnded) return;
            isHolding = true;
            
            const spawnInterval = setInterval(() => {
                if (!isHolding) {
                    clearInterval(spawnInterval);
                    return;
                }
                
                const currentRate = spawnRate + Math.floor(totalSpawned / 1000) * 100;
                const batchSize = Math.floor(currentRate / 2);
                spawnBalls(batchSize, x, y);
            }, 500);
            
            holdTimer = spawnInterval;
        }

        function stopHolding() {
            isHolding = false;
            if (holdTimer) {
                clearInterval(holdTimer);
                holdTimer = null;
            }
        }

        canvas.addEventListener('mousedown', (e) => {
            if (e.button === 0) {
                startHolding(e.clientX, e.clientY);
            }
        });

        canvas.addEventListener('mouseup', () => {
            stopHolding();
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            startHolding(touch.clientX, touch.clientY);
        });

        canvas.addEventListener('touchend', () => {
            stopHolding();
        });

        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });

        canvas.addEventListener('click', () => {
            if (testEnded) return;
            clickCount++;
            if (clickCount >= 3) {
                showHint();
                clickCount = 0;
            }
        });

        function showHint() {
            const hint = document.getElementById('hint');
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            hint.textContent = isMobile ? 'Hold down on the free area' : 'Hold down LMB (Left Mouse Button)';
            hint.classList.add('active');
            setTimeout(() => {
                hint.classList.remove('active');
            }, 3000);
        }

        function updateBallCount() {
            document.getElementById('ballCount').textContent = balls.length;
        }

        function findSimilarDevices(ballCount) {
            if (deviceDatabase.length === 0) {
                return ['Device database not loaded'];
            }

            const tolerance = 500;
            const matches = deviceDatabase.filter(device => {
                return Math.abs(device.balls - ballCount) <= tolerance;
            });

            matches.sort((a, b) => {
                return Math.abs(a.balls - ballCount) - Math.abs(b.balls - ballCount);
            });

            if (matches.length === 0) {
                return ['No similar devices found in database'];
            }

            return matches.slice(0, 5).map(device => device.name);
        }

        function animate() {
            if (testEnded) return;

            const currentTime = performance.now();
            const delta = currentTime - lastTime;
            const currentFps = Math.round(1000 / delta);
            lastTime = currentTime;

            fpsBuffer.push(currentFps);

            if (currentTime - lastFpsUpdate >= 500) {
                const avgCurrentFps = Math.round(fpsBuffer.reduce((a, b) => a + b, 0) / fpsBuffer.length);
                fps = avgCurrentFps;
                fpsBuffer = [];
                lastFpsUpdate = currentTime;

                if (measurementStarted) {
                    if (fps < minFps) minFps = fps;
                    if (fps > maxFps) maxFps = fps;
                    
                    frameCount++;
                    fpsSum += fps;

                    document.getElementById('fpsDisplay').textContent = fps + ' FPS';
                    document.getElementById('maxFps').textContent = maxFps;
                    document.getElementById('minFps').textContent = minFps;

                    if (fps <= 1) {
                        if (lowFpsStartTime === null) {
                            lowFpsStartTime = currentTime;
                        } else if (currentTime - lowFpsStartTime >= 5000) {
                            endTest();
                            return;
                        }
                    } else {
                        lowFpsStartTime = null;
                    }
                }
            }

            ctx.fillStyle = 'rgba(102, 126, 234, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            balls.forEach(ball => {
                ball.update();
                ball.draw();
            });

            requestAnimationFrame(animate);
        }

        function endTest() {
            testEnded = true;
            stopHolding();
            const avgFps = Math.round(fpsSum / frameCount);
            
            document.getElementById('totalBalls').textContent = balls.length;
            document.getElementById('modalStartFps').textContent = startFps || '--';
            document.getElementById('modalMaxFps').textContent = maxFps;
            document.getElementById('modalMinFps').textContent = minFps;
            document.getElementById('avgFps').textContent = avgFps;

            const similarDevices = findSimilarDevices(balls.length);
            const deviceListHtml = similarDevices.map(device => 
                `<div class="device-item">${device}</div>`
            ).join('');
            document.getElementById('deviceList').innerHTML = deviceListHtml;
            
            document.getElementById('modal').classList.add('active');
        }

        function repeatTest() {
            document.getElementById('modal').classList.remove('active');
            balls = [];
            testEnded = false;
            totalSpawned = 0;
            clickCount = 0;
            lowFpsStartTime = null;
            updateBallCount();
            lastTime = performance.now();
            lastFpsUpdate = performance.now();
            fpsBuffer = [];
            animate();
        }

        function resetAndRepeat() {
            location.reload();
        }

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        animate();
    </script>
</body>
</html>
